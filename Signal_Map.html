<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Signal Map</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
    }
    #bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
    }
    #graph {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }
    .node circle {
      stroke: #475569;
      stroke-width: 1.5px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
    }
    .node:hover circle {
      stroke-width: 2.5px;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
    }
    .node text {
      font-size: 11px;
      font-weight: 500;
      pointer-events: none;
      fill: #f1f5f9;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    }
    .link {
      stroke: #64748b;
      stroke-opacity: 0.35;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .tooltip {
      position: absolute;
      pointer-events: none;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.98) 0%, rgba(30, 41, 59, 0.98) 100%);
      color: #f1f5f9;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.6;
      max-width: 300px;
      opacity: 0;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 1px rgba(148, 163, 184, 0.5);
      backdrop-filter: blur(12px);
      transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 30;
    }
    .tooltip strong {
      color: #38bdf8;
      font-weight: 600;
    }
    #controls {
      position: absolute;
      bottom: 16px;
      left: 16px;
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4), 0 0 1px rgba(148, 163, 184, 0.3);
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: #f1f5f9;
      z-index: 40;
      backdrop-filter: blur(16px);
      min-width: 140px;
    }
    #logo {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 600;
      color: #f1f5f9;
      z-index: 40;
      letter-spacing: 0.5px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }
    #controls label {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    #controls label:hover {
      color: #38bdf8;
    }
    #controls label:last-child {
      margin-bottom: 0;
    }
    #controls input[type="checkbox"] {
      margin-right: 8px;
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    #controls .title {
      font-weight: 600;
      font-size: 13px;
      margin-bottom: 10px;
      color: #38bdf8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .node.highlight circle {
      stroke: #f59e0b;
      stroke-width: 3px;
      filter: drop-shadow(0 0 12px rgba(245, 158, 11, 0.8));
    }
    .link.highlight {
      stroke: #fbbf24;
      stroke-width: 3.5px;
      stroke-opacity: 0.9;
    }
    .node.dimmed circle {
      opacity: 0.15;
    }
    .link.dimmed {
      stroke-opacity: 0.08;
    }
  </style>
</head>
<body>
  <!-- Futuristic animated background -->
  <canvas id="bg"></canvas>

  <!-- Main signal graph -->
  <svg id="graph"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="logo">Investor Anatomy</div>
  <div id="controls">
    <div class="title">Filter</div>
    <label><input type="checkbox" data-filter="signals" checked> Signals</label>
    <label><input type="checkbox" data-filter="groups" checked> Macro Themes</label>
    <button id="exportBtn" style="margin-top: 12px; width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 12px;">Export Layout</button>
  </div>

  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script>
    // =========================
    // STARRY NIGHT SKY BACKGROUND
    // =========================
    (function initBackground() {
      const canvas = document.getElementById('bg');
      const ctx = canvas.getContext('2d');

      let width = window.innerWidth;
      let height = window.innerHeight;
      let stars = [];
      let milkyWayStars = [];

      function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width * window.devicePixelRatio;
        canvas.height = height * window.devicePixelRatio;
        ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
        generateStars();
      }

      function generateStars() {
        stars = [];
        milkyWayStars = [];
        
        // Regular stars scattered across the sky
        const starCount = Math.floor((width * height) / 2000);
        for (let i = 0; i < starCount; i++) {
          stars.push({
            x: Math.random() * width,
            y: Math.random() * height,
            radius: Math.random() * 1.5 + 0.3,
            opacity: Math.random() * 0.8 + 0.2,
            twinkleSpeed: Math.random() * 0.002 + 0.001,
            twinklePhase: Math.random() * Math.PI * 2
          });
        }

        // Milky Way band - denser cluster of smaller stars
        const milkyWayCount = Math.floor((width * height) / 800);
        const centerY = height * 0.4;
        const bandHeight = height * 0.3;
        
        for (let i = 0; i < milkyWayCount; i++) {
          const t = Math.random();
          const yOffset = (Math.random() - 0.5) * bandHeight * Math.pow(t, 2);
          
          milkyWayStars.push({
            x: Math.random() * width,
            y: centerY + yOffset,
            radius: Math.random() * 0.8 + 0.2,
            opacity: Math.random() * 0.4 + 0.1,
            twinkleSpeed: Math.random() * 0.003 + 0.001,
            twinklePhase: Math.random() * Math.PI * 2
          });
        }
      }

      function draw(time) {
        ctx.clearRect(0, 0, width, height);

        // Deep space gradient
        const grad = ctx.createRadialGradient(
          width * 0.5,
          height * 0.4,
          0,
          width * 0.5,
          height * 0.5,
          Math.max(width, height) * 0.8
        );
        grad.addColorStop(0, '#0a0e1a');
        grad.addColorStop(0.4, '#050810');
        grad.addColorStop(1, '#020408');
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, width, height);

        // Draw Milky Way glow
        ctx.save();
        const milkyWayGrad = ctx.createLinearGradient(0, height * 0.2, 0, height * 0.6);
        milkyWayGrad.addColorStop(0, 'rgba(60, 70, 120, 0)');
        milkyWayGrad.addColorStop(0.3, 'rgba(50, 60, 100, 0.08)');
        milkyWayGrad.addColorStop(0.5, 'rgba(60, 70, 110, 0.12)');
        milkyWayGrad.addColorStop(0.7, 'rgba(50, 60, 100, 0.08)');
        milkyWayGrad.addColorStop(1, 'rgba(60, 70, 120, 0)');
        ctx.fillStyle = milkyWayGrad;
        ctx.fillRect(0, 0, width, height);
        ctx.restore();

        const t = time || 0;

        // Draw Milky Way stars
        milkyWayStars.forEach(star => {
          const twinkle = Math.sin(star.twinklePhase + t * star.twinkleSpeed);
          const alpha = star.opacity * (0.7 + twinkle * 0.3);
          
          ctx.beginPath();
          ctx.fillStyle = `rgba(200, 210, 255, ${alpha})`;
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fill();
        });

        // Draw regular stars with twinkling
        stars.forEach(star => {
          const twinkle = Math.sin(star.twinklePhase + t * star.twinkleSpeed);
          const alpha = star.opacity * (0.6 + twinkle * 0.4);
          const glowSize = star.radius * (1.5 + twinkle * 0.5);
          
          // Star glow
          const starGrad = ctx.createRadialGradient(star.x, star.y, 0, star.x, star.y, glowSize);
          starGrad.addColorStop(0, `rgba(255, 255, 255, ${alpha})`);
          starGrad.addColorStop(0.3, `rgba(220, 230, 255, ${alpha * 0.6})`);
          starGrad.addColorStop(1, 'rgba(200, 210, 255, 0)');
          
          ctx.beginPath();
          ctx.fillStyle = starGrad;
          ctx.arc(star.x, star.y, glowSize, 0, Math.PI * 2);
          ctx.fill();
          
          // Bright star core
          ctx.beginPath();
          ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
          ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
          ctx.fill();
        });

        requestAnimationFrame(draw);
      }

      window.addEventListener('resize', resize);
      resize();
      requestAnimationFrame(draw);
    })();

    // =========================
    // DATA (with example hover fields)
    // =========================
    const nodes = [
      // Two main composite nodes
      { id: "us_macro_composite", type: "composite", label: "US Macro",
        description: "US fundamentals  policy, growth, inflation, labour, credit.",
        regime: "Cautious Neutral"
      },
      { id: "global_macro_composite", type: "composite", label: "Global Macro",
        description: "International pressures, trade cycles, and cross-currency drivers.",
        regime: "Neutral"
      },

      // US Macro Groups
      { id: "us_growth_cycle_group", type: "group", label: "US Growth & Business Cycle", description: "Growth direction is the primary driver of risk assets and cyclical rotations." },
      { id: "us_inflation_group", type: "group", label: "US Inflation & Price Dynamics", description: "Inflation sets the direction of monetary policy  affects yields, FX, equities, and credit." },
      { id: "us_labor_group", type: "group", label: "US Labour Market", description: "The labour market is one of the Fed's core constraints; it leads consumption and inflation." },
      { id: "us_liquidity_monetary_group", type: "group", label: "US Liquidity & Monetary", description: "Liquidity drives asset multiples, credit spreads, and volatility." },
      { id: "us_credit_group", type: "group", label: "US Credit Conditions", description: "Credit deteriorates before recessions and risk-off episodes." },

      // Global Macro Groups
      { id: "global_growth_group", type: "group", label: "Global Growth", description: "International manufacturing cycles and commodity-driven growth signals." },
      { id: "global_trade_demand_group", type: "group", label: "Global Trade & Demand", description: "Global liquidity, USD strength, and international risk sentiment." },
      { id: "global_inflation_fx_group", type: "group", label: "Global Inflation/FX Dynamics", description: "USD strength and commodity price impulses affecting global inflation." },

      // Cross-Asset Positioning (connects to both composites)
      { id: "positioning_sentiment_group", type: "group", label: "Cross-Asset Positioning & Sentiment", description: "Universal timing signals for squeezes, regime shifts, and tactical turning points." },

      // --- Signals with methodology links --- 
      { id: "fed_inflation_signal.html", type: "signal", label: "US Inflation Signal",
        source: "FRED",
        purpose: "To measure inflation pressure from multiple data sources and classify the regime as HOT, NEUTRAL, or COOL for policy risk assessment.",
        wip: false, notes: "N/A" },

      { id: "wage_growth_and_inflation_methodology.html", type: "signal", label: "Wage Growth Composite",
        source: "BLS",
        purpose: "To track wage inflation pressure and labor market tightness for identifying persistent inflation risk or disinflationary relief.",
        wip: false, notes: "N/A" },

      { id: "Durable_goods_capex_intent_methodology.html", type: "signal", label: "Durables / Capex Intent",
        source: "FRED",
        purpose: "To infer forward business investment trends and detect expansion, neutral, or contraction phases in capital expenditure cycles.",
        wip: false, notes: "N/A" },

      { id: "labor_market_tightness_methodology.html", type: "signal", label: "Labor Market Tightness",
        source: "BLS",
        purpose: "To assess labor market tightness by tracking quits, layoffs, and job openings for identifying wage pressure and hiring frictions.",
        wip: false, notes: "N/A" },

      { id: "weekly_hours_methodology.html", type: "signal", label: "Average Weekly Hours",
        source: "BLS",
        purpose: "To provide a lead indicator of labor demand, as firms adjust hours before headcount changes.",
        wip: false, notes: "N/A" },

      { id: "Federal_Reserve_Liquidity_Composite.html", type: "signal", label: "Fed Liquidity Composite",
        source: "FRED",
        purpose: "To track Fed liquidity conditions by blending M2, balance sheet channels, and ON RRP into expansion, neutral, or contraction regimes.",
        wip: false, notes: "N/A" },

      { id: "yield_curve_slope_methodology.html", type: "signal", label: "Yield Curve Slope",
        source: "FRED",
        purpose: "To track whether the economy is entering a recovery, staying neutral, or heading toward stress by reading the shape of the yield curve.",
        wip: false, notes: "N/A" },

      { id: "US_Treasury_Yield_Curve_Slope.html", type: "signal", label: "US Treasury Yield Curve Slope (GS10-FEDFUNDS)",
        source: "FRED",
        purpose: "To derive a level-trend regime signal from 10Y-FFR spread using transparent thresholds and steepening tests for risk asset classification.",
        wip: false, notes: "N/A" },

      { id: "credit_spreads_methodology.html", type: "signal", label: "Credit Spreads",
        source: "FRED",
        purpose: "To measure corporate funding stress through ICE BofA option-adjusted spreads and identify easy, normal, tightening, or stressed credit regimes.",
        wip: false, notes: "N/A" },

      { id: "financial_stress_composite_methodology.html", type: "signal", label: "Financial Stress Composite",
        source: "FRED",
        purpose: "To assess market stress levels by integrating credit spreads, yield-curve inversion, and systemic stress indicators.",
        wip: false, notes: "N/A" },

      { id: "usd_index_signal.html", type: "signal", label: "USD Index",
        source: "FRED",
        purpose: "To derive a macro-directional risk signal from the Broad U.S. Dollar Index for FX strategies and commodity risk interpretation.",
        wip: false, notes: "N/A" },

      { id: "vix_signal_methodology.html", type: "signal", label: "Market Volatility (VIX)",
        source: "CBOE",
        purpose: "To capture option-implied risk sentiment from S&P 500 volatility and classify regimes from calm to crisis conditions.",
        wip: false, notes: "N/A" },

      { id: "Consumer_Sentiment.html", type: "signal", label: "UMich Sentiment",
        source: "FRED",
        purpose: "To transform consumer sentiment into a monthly demand signal capturing relative optimism or pessimism with momentum context.",
        wip: false, notes: "N/A" },

      { id: "Cross_Sector_Positioning.html", type: "signal", label: "CoT Cross-Sector Positioning",
        source: "CFTC",
        purpose: "To aggregate market-level CoT positioning into macro sectors for identifying speculative crowding and unwind risk.",
        wip: false, notes: "N/A" },

      { id: "Squeeze_Exhaustion_Risk.html", type: "signal", label: "CoT Squeeze / Exhaustion",
        source: "CFTC",
        purpose: "To measure how broadly squeeze and exhaustion conditions appear across futures markets for tactical reversal signals.",
        wip: false, notes: "N/A" },

      { id: "Specs_vs_Hedgers_Divergence_Reversal_Risk.html", type: "signal", label: "Specs vs Hedgers",
        source: "CFTC",
        purpose: "To capture positioning tension between speculators and hedgers for highlighting periods of potential reversal and unstable market structure.",
        wip: false, notes: "N/A" },

      { id: "Gold_CoT_Signals.html", type: "signal", label: "Gold CoT Signal",
        source: "CFTC",
        purpose: "To analyze positioning, flow, and reversal risk for gold futures to support precious metals tactical decisions.",
        wip: false, notes: "N/A" },

      { id: "Silver_CoT_Signals.html", type: "signal", label: "Silver CoT Signal",
        source: "CFTC",
        purpose: "To analyze positioning, flow, and reversal risk for silver futures to support precious metals tactical decisions.",
        wip: false, notes: "N/A" },

      { id: "Copper_single_market_cot_methodology.html", type: "signal", label: "Copper CoT Signal",
        source: "CFTC",
        purpose: "To analyze positioning, flow, and reversal risk for copper futures to support industrial metals tactical decisions.",
        wip: true, notes: "N/A" },

      { id: "credit_conditions_methodology.html", type: "signal", label: "Credit Conditions",
        source: "FRED",
        purpose: "To proxy credit conditions by combining spread-level stress from corporate bond markets with equity volatility for assessing funding conditions.",
        wip: false, notes: "N/A" },

      { id: "employment_composition_methodology.html", type: "signal", label: "Employment Composition",
        source: "BLS",
        purpose: "To construct a monthly index of labor market health from participation, employment-population ratio, and unemployment for identifying market slack.",
        wip: false, notes: "N/A" },

      { id: "housing_lead_methodology.html", type: "signal", label: "Housing Lead",
        source: "FRED",
        purpose: "To blend forward indicators of residential activity with mortgage rate constraints for anticipating housing cycle turns.",
        wip: false, notes: "N/A" },

      { id: "industrial_production_signal.html", type: "signal", label: "Industrial Production",
        source: "FRED",
        purpose: "To combine industrial demand and mining supply pressure for generating cyclical and metals exposure signals.",
        wip: false, notes: "N/A" },

      { id: "m_2_money_supply.html", type: "signal", label: "M2 Money Supply",
        source: "FRED",
        purpose: "To derive a macro liquidity signal from M2 growth and momentum for precious metals and cyclical risk applications.",
        wip: false, notes: "N/A" },

      { id: "job_flows_labor_methodology.html", type: "signal", label: "Job Flows & Labor Dynamism",
        source: "BLS",
        purpose: "To track firm dynamism and hiring appetite through gross job gains and losses for identifying labor market deterioration.",
        wip: false, notes: "N/A" },

      { id: "private_credit_impulse_methodology.html", type: "signal", label: "Private Credit Impulse",
        source: "FRED",
        purpose: "To quantify acceleration or deceleration in private-sector credit growth for identifying credit regime changes.",
        wip: false, notes: "N/A" },

      { id: "Real_Interest_Rate_Trend_Signal.html", type: "signal", label: "Real Interest Rate",
        source: "FRED",
        purpose: "To derive market regime signals from the 10-year real yield for aligning monetary conditions with macro interpretation.",
        wip: false, notes: "N/A" },

      { id: "energy_adjusted_metals_tailwind_methodology.html", type: "signal", label: "Energy-Adjusted Metals Tailwind",
        source: "FRED",
        purpose: "To extract copper-specific demand residual after controlling for energy and USD to identify metals demand tailwinds.",
        wip: false, notes: "N/A" },

      { id: "inflation_term_structure_methodology.html", type: "signal", label: "Inflation Term Structure",
        source: "FRED",
        purpose: "To blend breakeven curve slope and real yields for classifying reflation, neutral, or disinflation regimes.",
        wip: false, notes: "N/A" },

      { id: "labour_market_momentum_methodology.html", type: "signal", label: "Labour Market Momentum",
        source: "FRED",
        purpose: "To measure labour market strength by combining jobless claims trends with payroll growth for identifying tightening or softening dynamics.",
        wip: false, notes: "N/A" },

      { id: "sectoral_employment_methodology.html", type: "signal", label: "Sectoral Employment Diffusion",
        source: "BLS",
        purpose: "To track breadth and momentum of payroll growth across sectors for anticipating durable expansions or slowdowns.",
        wip: false, notes: "N/A" },

      { id: "underemployment_risk_methodology.html", type: "signal", label: "Underemployment Risk",
        source: "BLS",
        purpose: "To construct a stress indicator from U-6 underutilization and unemployment duration for identifying labor market slack.",
        wip: false, notes: "N/A" },

      { id: "market_implied_inflation_signal.html", type: "signal", label: "Market-Implied Inflation",
        source: "FRED",
        purpose: "To summarize forward inflation expectations from TIPS breakevens for identifying rising, stable, or falling expectations.",
        wip: false, notes: "N/A" },

      { id: "policy_relevant_inflation_pce_methodology.html", type: "signal", label: "Policy-Relevant Inflation (PCE)",
        source: "FRED",
        purpose: "To combine headline and core PCE inflation for mirroring the Fed's policy focus with hot, neutral, or cool regimes.",
        wip: false, notes: "N/A" },

      { id: "US_CPI_vs_PPI_Divergence_Inflation.html", type: "signal", label: "CPI vs PPI Divergence",
        source: "FRED",
        purpose: "To exploit producer-consumer price divergence for detecting inflationary pressure and regime transitions.",
        wip: false, notes: "N/A" },

      { id: "Financial_Stress.html", type: "signal", label: "Financial Stress Index (STLFSI4)",
        source: "FRED",
        purpose: "To convert the St. Louis Fed's composite financial stress index into a weekly risk-on/risk-off classifier using robust z-score and regime rules.",
        wip: false, notes: "N/A" },

      { id: "Economic_Cycle_Proxies_Flow_Momentum.html", type: "signal", label: "Sector Flow & Momentum",
        source: "CFTC",
        purpose: "To aggregate 4-week speculative flows across futures sectors for identifying economic cycle dynamics and turning points.",
        wip: false, notes: "N/A" },

      { id: "Global_Positioning_Tone.html", type: "signal", label: "CoT Market Tone",
        source: "CFTC",
        purpose: "To measure systemic Risk-On vs Risk-Off tone using speculative crowding breadth across all futures markets.",
        wip: false, notes: "N/A" },

      { id: "Hedger_Pressure_Indicator.html", type: "signal", label: "Hedger Pressure",
        source: "CFTC",
        purpose: "To capture commercial hedger sentiment for identifying supply expansion stress or physical shortage signals.",
        wip: false, notes: "N/A" },

      { id: "Labor_Market_Turnover.html", type: "signal", label: "Labor Market Turnover Differential",
        source: "FRED",
        purpose: "To gauge labor market tightness by comparing worker quits to employer layoffs for identifying confidence and slack.",
        wip: false, notes: "N/A" },

      { id: "Manufactureres_new_goods.html", type: "signal", label: "Durable Goods ex-Transportation",
        source: "FRED",
        purpose: "To track momentum in core U.S. manufacturing orders for identifying capex trends without transportation volatility.",
        wip: false, notes: "N/A" },

      { id: "Portfolio_Level_Early_Warning_System.html", type: "signal", label: "CoT Early Warning Index",
        source: "CFTC",
        purpose: "To detect cross-market instability through extremes, crowding, and squeeze/exhaustion pressure for volatility cluster warnings.",
        wip: false, notes: "N/A" },

      { id: "Regimes_specific_Macro_Themes_Continuous.html", type: "signal", label: "Macro Themes from CoT",
        source: "CFTC",
        purpose: "To map cross-market positioning into macro themes identifying inflation impulse, disinflation, global slowdown, and supply stress.",
        wip: false, notes: "N/A" }
    ];

    // Link importance: higher = thicker
    const links = [
      // US Inflation signals
      { source: "fed_inflation_signal.html", target: "us_inflation_group", importance: 1.2 },
      { source: "wage_growth_and_inflation_methodology.html", target: "us_inflation_group", importance: 1.2 },
      { source: "inflation_term_structure_methodology.html", target: "us_inflation_group", importance: 1.1 },
      { source: "market_implied_inflation_signal.html", target: "us_inflation_group", importance: 1.1 },
      { source: "policy_relevant_inflation_pce_methodology.html", target: "us_inflation_group", importance: 1.2 },
      { source: "US_CPI_vs_PPI_Divergence_Inflation.html", target: "us_inflation_group", importance: 1.1 },
      
      // US Growth & Business Cycle signals
      { source: "yield_curve_slope_methodology.html", target: "us_growth_cycle_group", importance: 1.5 },
      { source: "US_Treasury_Yield_Curve_Slope.html", target: "us_growth_cycle_group", importance: 1.4 },
      { source: "Durable_goods_capex_intent_methodology.html", target: "us_growth_cycle_group", importance: 1.2 },
      { source: "Manufactureres_new_goods.html", target: "us_growth_cycle_group", importance: 1.2 },
      { source: "industrial_production_signal.html", target: "us_growth_cycle_group", importance: 1.2 },
      
      // US Labour Market signals
      { source: "labor_market_tightness_methodology.html", target: "us_labor_group", importance: 1.2 },
      { source: "job_flows_labor_methodology.html", target: "us_labor_group", importance: 1.0 },
      { source: "weekly_hours_methodology.html", target: "us_labor_group", importance: 1.0 },
      { source: "underemployment_risk_methodology.html", target: "us_labor_group", importance: 1.1 },
      { source: "employment_composition_methodology.html", target: "us_labor_group", importance: 1.1 },
      { source: "labour_market_momentum_methodology.html", target: "us_labor_group", importance: 1.1 },
      { source: "sectoral_employment_methodology.html", target: "us_labor_group", importance: 1.0 },
      { source: "Labor_Market_Turnover.html", target: "us_labor_group", importance: 1.1 },
      
      // US Liquidity & Monetary signals
      { source: "Federal_Reserve_Liquidity_Composite.html", target: "us_liquidity_monetary_group", importance: 1.5 },
      { source: "m_2_money_supply.html", target: "us_liquidity_monetary_group", importance: 1.3 },
      { source: "Real_Interest_Rate_Trend_Signal.html", target: "us_liquidity_monetary_group", importance: 1.4 },
      
      // US Credit Conditions signals
      { source: "credit_spreads_methodology.html", target: "us_credit_group", importance: 1.4 },
      { source: "financial_stress_composite_methodology.html", target: "us_credit_group", importance: 1.6 },
      { source: "Financial_Stress.html", target: "us_credit_group", importance: 1.5 },
      { source: "credit_conditions_methodology.html", target: "us_credit_group", importance: 1.4 },
      { source: "private_credit_impulse_methodology.html", target: "us_credit_group", importance: 1.3 },
      
      // Global Growth signals
      { source: "Copper_single_market_cot_methodology.html", target: "global_growth_group", importance: 1.3 },
      { source: "Gold_CoT_Signals.html", target: "global_growth_group", importance: 1.3 },
      { source: "Silver_CoT_Signals.html", target: "global_growth_group", importance: 1.3 },
      { source: "energy_adjusted_metals_tailwind_methodology.html", target: "global_growth_group", importance: 1.2 },
      { source: "Economic_Cycle_Proxies_Flow_Momentum.html", target: "global_growth_group", importance: 1.3 },
      
      // Global Trade & Demand signals
      { source: "usd_index_signal.html", target: "global_trade_demand_group", importance: 1.4 },
      { source: "Global_Positioning_Tone.html", target: "global_trade_demand_group", importance: 1.4 },
      { source: "Regimes_specific_Macro_Themes_Continuous.html", target: "global_trade_demand_group", importance: 1.4 },
      
      // Global Inflation/FX signals
      { source: "usd_index_signal.html", target: "global_inflation_fx_group", importance: 1.3 },
      
      // Cross-Asset Positioning & Sentiment signals
      { source: "vix_signal_methodology.html", target: "positioning_sentiment_group", importance: 1.3 },
      { source: "Specs_vs_Hedgers_Divergence_Reversal_Risk.html", target: "positioning_sentiment_group", importance: 1.4 },
      { source: "Cross_Sector_Positioning.html", target: "positioning_sentiment_group", importance: 1.4 },
      { source: "Squeeze_Exhaustion_Risk.html", target: "positioning_sentiment_group", importance: 1.4 },
      { source: "Regimes_specific_Macro_Themes_Continuous.html", target: "positioning_sentiment_group", importance: 1.4 },
      { source: "Hedger_Pressure_Indicator.html", target: "positioning_sentiment_group", importance: 1.3 },
      { source: "Portfolio_Level_Early_Warning_System.html", target: "positioning_sentiment_group", importance: 1.5 },

      // US Macro groups to US composite
      { source: "us_growth_cycle_group", target: "us_macro_composite", importance: 2.0 },
      { source: "us_inflation_group", target: "us_macro_composite", importance: 2.0 },
      { source: "us_labor_group", target: "us_macro_composite", importance: 2.0 },
      { source: "us_liquidity_monetary_group", target: "us_macro_composite", importance: 2.0 },
      { source: "us_credit_group", target: "us_macro_composite", importance: 2.0 },

      // Global Macro groups to Global composite
      { source: "global_growth_group", target: "global_macro_composite", importance: 2.0 },
      { source: "global_trade_demand_group", target: "global_macro_composite", importance: 2.0 },
      { source: "global_inflation_fx_group", target: "global_macro_composite", importance: 1.8 },

      // Positioning connects to both composites
      { source: "positioning_sentiment_group", target: "us_macro_composite", importance: 1.6 },
      { source: "positioning_sentiment_group", target: "global_macro_composite", importance: 1.6 },

      // Link the two composites together
      { source: "global_macro_composite", target: "us_macro_composite", importance: 2.5 }
    ];

    // Group membership for expand/contract
    const groupMembers = {
      us_growth_cycle_group: ["yield_curve_slope_methodology.html", "US_Treasury_Yield_Curve_Slope.html", "Durable_goods_capex_intent_methodology.html", "Manufactureres_new_goods.html", "industrial_production_signal.html"],
      us_inflation_group: ["fed_inflation_signal.html", "wage_growth_and_inflation_methodology.html", "inflation_term_structure_methodology.html", "market_implied_inflation_signal.html", "policy_relevant_inflation_pce_methodology.html", "US_CPI_vs_PPI_Divergence_Inflation.html"],
      us_labor_group: ["labor_market_tightness_methodology.html", "job_flows_labor_methodology.html", "weekly_hours_methodology.html", "underemployment_risk_methodology.html", "employment_composition_methodology.html", "labour_market_momentum_methodology.html", "sectoral_employment_methodology.html", "Labor_Market_Turnover.html"],
      us_liquidity_monetary_group: ["Federal_Reserve_Liquidity_Composite.html", "m_2_money_supply.html", "Real_Interest_Rate_Trend_Signal.html"],
      us_credit_group: ["credit_spreads_methodology.html", "financial_stress_composite_methodology.html", "Financial_Stress.html", "credit_conditions_methodology.html", "private_credit_impulse_methodology.html"],
      global_growth_group: ["Copper_single_market_cot_methodology.html", "Gold_CoT_Signals.html", "Silver_CoT_Signals.html", "energy_adjusted_metals_tailwind_methodology.html", "Economic_Cycle_Proxies_Flow_Momentum.html"],
      global_trade_demand_group: ["usd_index_signal.html", "Global_Positioning_Tone.html", "Regimes_specific_Macro_Themes_Continuous.html"],
      global_inflation_fx_group: ["usd_index_signal.html"],
      positioning_sentiment_group: ["vix_signal_methodology.html", "Specs_vs_Hedgers_Divergence_Reversal_Risk.html", "Cross_Sector_Positioning.html", "Squeeze_Exhaustion_Risk.html", "Regimes_specific_Macro_Themes_Continuous.html", "Hedger_Pressure_Indicator.html", "Portfolio_Level_Early_Warning_System.html"]
    };

    const collapsedGroups = new Set();
    const idToNode = {};
    nodes.forEach(n => { idToNode[n.id] = n; });

    // Hardcode node positions from provided JSON
    const hardcodedPositions = {
      "us_macro_composite": { "x": 954, "y": 422 },
      "global_macro_composite": { "x": 577, "y": 434 },
      "us_growth_cycle_group": { "x": 907, "y": 205 },
      "us_inflation_group": { "x": 1130, "y": 342 },
      "us_labor_group": { "x": 817, "y": 503 },
      "us_liquidity_monetary_group": { "x": 1165, "y": 545 },
      "us_credit_group": { "x": 1028, "y": 619 },
      "global_growth_group": { "x": 315, "y": 590 },
      "global_trade_demand_group": { "x": 381, "y": 371 },
      "global_inflation_fx_group": { "x": 308, "y": 470 },
      "positioning_sentiment_group": { "x": 712, "y": 277 },
      "fed_inflation_signal.html": { "x": 1035, "y": 304 },
      "wage_growth_and_inflation_methodology.html": { "x": 1092, "y": 248 },
      "Durable_goods_capex_intent_methodology.html": { "x": 1047, "y": 148 },
      "labor_market_tightness_methodology.html": { "x": 799, "y": 683 },
      "weekly_hours_methodology.html": { "x": 760, "y": 654 },
      "Federal_Reserve_Liquidity_Composite.html": { "x": 1270, "y": 492 },
      "yield_curve_slope_methodology.html": { "x": 910, "y": 54 },
      "US_Treasury_Yield_Curve_Slope.html": { "x": 969, "y": 73 },
      "credit_spreads_methodology.html": { "x": 1141, "y": 698 },
      "financial_stress_composite_methodology.html": { "x": 1111, "y": 772 },
      "usd_index_signal.html": { "x": 213, "y": 358 },
      "vix_signal_methodology.html": { "x": 758, "y": 219 },
      "Consumer_Sentiment.html": { "x": 26, "y": -4216 },
      "Cross_Sector_Positioning.html": { "x": 733, "y": 167 },
      "Squeeze_Exhaustion_Risk.html": { "x": 741, "y": 322 },
      "Specs_vs_Hedgers_Divergence_Reversal_Risk.html": { "x": 671, "y": 138 },
      "Gold_CoT_Signals.html": { "x": 241, "y": 736 },
      "Silver_CoT_Signals.html": { "x": 161, "y": 659 },
      "Copper_single_market_cot_methodology.html": { "x": 153, "y": 552 },
      "credit_conditions_methodology.html": { "x": 1062, "y": 789 },
      "employment_composition_methodology.html": { "x": 860, "y": 588 },
      "housing_lead_methodology.html": { "x": -764, "y": 5358 },
      "industrial_production_signal.html": { "x": 1005, "y": 106 },
      "m_2_money_supply.html": { "x": 1277, "y": 590 },
      "job_flows_labor_methodology.html": { "x": 686, "y": 594 },
      "private_credit_impulse_methodology.html": { "x": 959, "y": 725 },
      "Real_Interest_Rate_Trend_Signal.html": { "x": 1271, "y": 639 },
      "energy_adjusted_metals_tailwind_methodology.html": { "x": 191, "y": 703 },
      "inflation_term_structure_methodology.html": { "x": 1284, "y": 262 },
      "labour_market_momentum_methodology.html": { "x": 716, "y": 634 },
      "sectoral_employment_methodology.html": { "x": 676, "y": 470 },
      "underemployment_risk_methodology.html": { "x": 869, "y": 630 },
      "market_implied_inflation_signal.html": { "x": 1302, "y": 318 },
      "policy_relevant_inflation_pce_methodology.html": { "x": 1246, "y": 215 },
      "US_CPI_vs_PPI_Divergence_Inflation.html": { "x": 1229, "y": 377 },
      "Financial_Stress.html": { "x": 942, "y": 661 },
      "Economic_Cycle_Proxies_Flow_Momentum.html": { "x": 147, "y": 609 },
      "Global_Positioning_Tone.html": { "x": 241, "y": 272 },
      "Hedger_Pressure_Indicator.html": { "x": 540, "y": 210 },
      "Labor_Market_Turnover.html": { "x": 661, "y": 536 },
      "Manufactureres_new_goods.html": { "x": 850, "y": 137 },
      "Portfolio_Level_Early_Warning_System.html": { "x": 563, "y": 156 },
      "Regimes_specific_Macro_Themes_Continuous.html": { "x": 451, "y": 261 }
    };

    nodes.forEach(n => {
      if (hardcodedPositions[n.id]) {
        n.x = hardcodedPositions[n.id].x;
        n.y = hardcodedPositions[n.id].y;
        // Do not set fx/fy so nodes are fluid after initialization
      }
    });

    // =========================
    // FORCE GRAPH SETUP
    // =========================
    const svg = d3.select("#graph");
    const tooltip = d3.select("#tooltip");
    const width = window.innerWidth;
    const height = window.innerHeight;
    svg.attr("width", width).attr("height", height);

    // Modern professional color palette
    function getNodeColor(d) {
      if (d.type === "signal") {
        // Work in progress signals are grey
        if (d.wip) return "#6b7280";
        
        // Z-score based coloring for completed signals
        if (d.zScore) {
          const v = parseFloat(d.zScore);
          if (!isNaN(v)) {
            if (v >= 0.75) return "#ef4444";      // HOT - Modern red
            if (v <= -0.75) return "#3b82f6";     // COOL - Modern blue
            return "#60a5fa";                     // Neutral signal - Lighter blue
          }
        }
        return "#f1f5f9";                         // Default white for signals
      }
      if (d.type === "group") return "#dc2626";        // Red dwarf for macro themes
      if (d.type === "composite") return "#3b82f6";    // Blue star for composite
      if (d.type === "output") return "#8b5cf6";       // Modern purple
      return "#94a3b8";                                // Modern slate
    }

    const radius = (d) => {
      if (d.type === "composite") return 16;
      if (d.type === "group") return 14;
      if (d.type === "output") return 14;
      return 10;
    };

    const simulation = d3.forceSimulation(nodes)
      .force("link", d3.forceLink(links).id(d => d.id).distance(130).strength(0.6))
      .force("charge", d3.forceManyBody().strength(-250))
      .force("center", d3.forceCenter(width / 2, height / 2))
      .force("collide", d3.forceCollide().radius(d => radius(d) + 6));

    // Add glow filter for stars
    const defs = svg.append("defs");
    const filter = defs.append("filter")
      .attr("id", "glow")
      .attr("x", "-50%")
      .attr("y", "-50%")
      .attr("width", "200%")
      .attr("height", "200%");
    
    filter.append("feGaussianBlur")
      .attr("stdDeviation", "2")
      .attr("result", "coloredBlur");
    
    const feMerge = filter.append("feMerge");
    feMerge.append("feMergeNode").attr("in", "coloredBlur");
    feMerge.append("feMergeNode").attr("in", "SourceGraphic");

    // Create a container group for zoom/pan
    const container = svg.append("g");

    const link = container.append("g")
      .attr("stroke-width", 1.2)
      .selectAll("line")
      .data(links)
      .enter()
      .append("line")
      .attr("class", "link")
      .attr("stroke-width", d => d.importance || 1.2);

    const node = container.append("g")
      .selectAll("g")
      .data(nodes)
      .enter()
      .append("g")
      .attr("class", "node")
      .call(d3.drag()
        .on("start", dragstarted)
        .on("drag", dragged)
        .on("end", dragended)
      );

    node.append("circle")
      .attr("r", d => radius(d))
      .attr("fill", d => getNodeColor(d))
      .attr("filter", "url(#glow)");

    node.append("text")
      .attr("x", d => radius(d) + 3)
      .attr("y", 3)
      .text(d => d.label);

    // =========================
    // HOVER TOOLTIP
    // =========================
    node.on("mouseover", (event, d) => {
      const isSignal = d.type === "signal";
      let html = `<strong>${d.label}</strong><br/><em>Type: ${d.type === "group" ? "Macro Theme" : d.type}</em>`;

      if (isSignal) {
        if (d.wip) html += `<br/><span style="color: #fbbf24;"><strong>âš  Work in Progress</strong></span>`;
        if (d.source) html += `<br/><strong>Source:</strong> ${d.source}`;
        if (d.purpose) html += `<br/><strong>Purpose:</strong> ${d.purpose}`;
        if (d.notes && d.notes !== "N/A") html += `<br/><strong>Notes:</strong> ${d.notes}`;
      } else {
        if (d.regime) html += `<br/><strong>Regime:</strong> ${d.regime}`;
        if (d.description) html += `<br/><strong>Summary:</strong> ${d.description}`;
      }

      tooltip
        .style("opacity", 1)
        .html(html);
    })
    .on("mousemove", (event) => {
      const padding = 12;
      tooltip
        .style("left", (event.pageX + padding) + "px")
        .style("top", (event.pageY + padding) + "px");
    })
    .on("mouseout", () => {
      tooltip.style("opacity", 0);
    })
    .on("click", (event, d) => {
      // Expand/contract for groups
      if (d.type === "group" && groupMembers[d.id]) {
        if (collapsedGroups.has(d.id)) {
          collapsedGroups.delete(d.id);
        } else {
          collapsedGroups.add(d.id);
        }
        updateVisibility();
      }

      // Clicking US or Global macro composite opens your macro page
      if (d.id === "us_macro_composite" || d.id === "global_macro_composite") {
        window.open("https://sensational-stroopwafel-d10a4c.netlify.app/", "_blank");
      }

      // Clicking a signal opens its methodology page
      if (d.type === "signal") {
        const methodologyUrl = `https://sensational-stroopwafel-d10a4c.netlify.app/signal_report/${d.id}`;
        window.open(methodologyUrl, "_blank");
      }
    });

    // =========================
    // TICK UPDATE
    // =========================
    simulation.on("tick", () => {
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);

      node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      const transform = d3.zoomTransform(svg.node());
      d.fx = (event.x - transform.x) / transform.k;
      d.fy = (event.y - transform.y) / transform.k;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      // Keep nodes fixed after dragging instead of releasing them
      d.fx = d.x;
      d.fy = d.y;
    }

    // Zoom & pan
    const zoom = d3.zoom()
      .scaleExtent([0.2, 3])
      .on("zoom", (event) => {
        container.attr("transform", event.transform);
      });

    svg.call(zoom);

    // =========================
    // FILTERING & VISIBILITY
    // =========================
    const filterState = {
      signals: true,
      groups: true
    };

    function isCoTNode(d) {
      return d.id.startsWith("cot_");
    }

    function updateVisibility() {
      // Mark hidden flag on nodes
      node.each(function(d) {
        let hidden = false;

        if (d.type === "signal" && !filterState.signals) hidden = true;
        if (d.type === "group" && !filterState.groups) hidden = true;
        if (d.type === "output" && !filterState.outputs) hidden = true;
        if (!filterState.cot && isCoTNode(d)) hidden = true;

        // Collapsed groups hide their members
        for (const g of collapsedGroups) {
          const members = groupMembers[g] || [];
          if (members.includes(d.id)) {
            hidden = true;
          }
        }

        d.hidden = hidden;
        d3.select(this).style("display", hidden ? "none" : null);
      });

      // Hide links if either endpoint is hidden
      link.each(function(d) {
        const hidden = d.source.hidden || d.target.hidden;
        d3.select(this).style("display", hidden ? "none" : null);
      });
    }

    // Controls events
    document.querySelectorAll('#controls input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', (e) => {
        const key = e.target.getAttribute('data-filter');
        const checked = e.target.checked;
        if (key in filterState) {
          filterState[key] = checked;
          updateVisibility();
        }
      });
    });

    // Initial visibility
    updateVisibility();

    // =========================
    // EXPORT & LOAD LAYOUT
    // =========================
    
    // Export current layout to JSON file
    function exportLayout() {
      const positions = {};
      node.each(d => {
        positions[d.id] = {
          x: Math.round(d.x),
          y: Math.round(d.y)
        };
      });
      
      const dataStr = JSON.stringify(positions, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'signal-map-layout.json';
      link.click();
      
      console.log('Layout exported!');
    }

    // Load layout from JSON file in project directory
    function loadLayout() {
      fetch('signal-map-layout.json')
        .then(response => {
          if (!response.ok) {
            console.log('No saved layout found, using force simulation');
            return null;
          }
          return response.json();
        })
        .then(positions => {
          if (positions) {
            nodes.forEach(n => {
              if (positions[n.id]) {
                n.x = positions[n.id].x;
                n.y = positions[n.id].y;
                n.fx = positions[n.id].x;
                n.fy = positions[n.id].y;
              }
            });
            simulation.alpha(0).restart();
            console.log('Layout loaded from signal-map-layout.json');
          }
        })
        .catch(err => {
          console.log('Using dynamic layout:', err);
        });
    }

    // Load saved layout if available
    loadLayout();

    // Attach export button click handler
    document.getElementById('exportBtn').addEventListener('click', exportLayout);

  </script>
</body>
</html>
