<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Squeeze & Exhaustion Breadth — Methodology</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:"Merriweather",serif}
    h1,h2,h3,h4{font-family:"Inter",sans-serif}
    .container{max-width:960px}
    .rule{height:1px;background:linear-gradient(90deg,#e5e7eb,transparent)}
    .smallcaps{font-variant-caps:all-small-caps;letter-spacing:.04em}
    @media print{nav,.screen-only{display:none!important} body{color:#000}}
    .eq{font-family:"Merriweather",serif;font-style:italic}
    .box{border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem;background:#fafafa}
    code{background:#f6f8fa;padding:.15rem .35rem;border-radius:.35rem}
  </style>
</head>
<body class="bg-white text-slate-800">
  <nav class="screen-only border-b">
    <div class="container mx-auto px-5 py-3 flex items-center justify-between text-sm text-slate-600">
      <div class="smallcaps">Methodology White Paper</div>
      <div>Version 1.0</div>
    </div>
  </nav>

  <main class="container mx-auto px-5 py-10">
    <header class="mb-10">
      <h1 class="text-3xl md:text-4xl font-semibold text-slate-900">Squeeze &amp; Exhaustion Breadth</h1>
      <div class="mt-2 text-slate-600 text-sm">Cross-market tactical signal tracking how widespread short-squeeze and exhaustion risks are across the futures universe, based on CoT-derived squeeze_risk and exhaustion_risk flags.</div>
    </header>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold text-slate-900 mb-3">Abstract</h2>
      <p class="leading-7">This signal measures how broadly <em>squeeze</em> and <em>exhaustion</em> conditions appear across futures markets in the CoT dataset. For each report date, it aggregates market-level tactical flags (squeeze_risk, exhaustion_risk) into breadth measures, normalises them with a robust z-score, and maps them into simple regimes such as High Squeeze Risk or High Exhaustion Risk. The result is a compact indicator of whether the futures complex is vulnerable to forced covering or trend fatigue.</p>
    </section>

    <div class="rule mb-10"></div>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">1. Inputs</h2>
      <ul class="list-disc pl-6 leading-7">
        <li><strong>df_cot_signals</strong> — unified enriched CoT dataset with market-level positioning and tactical flags.</li>
        <li><strong>squeeze_risk</strong> — boolean flag for markets at risk of short- or long-squeeze events.</li>
        <li><strong>exhaustion_risk</strong> — boolean flag for markets showing late-trend exhaustion characteristics.</li>
        <li><strong>crowded_long / crowded_short</strong> — crowding context (stored but not directly used in the z-signal here).</li>
        <li><strong>Market_and_Exchange_Names</strong> — used to count distinct markets per report date.</li>
      </ul>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">2. Daily Aggregation</h2>
      <p class="leading-7">For each CoT report date, the model aggregates tactical flags into cross-market breadth metrics:</p>
      <ul class="list-disc pl-6 leading-7 mt-3">
        <li><strong>n_markets</strong> — number of unique markets.</li>
        <li><strong>squeeze_count</strong> — number of markets with <span class="eq">squeeze_risk = True</span>.</li>
        <li><strong>exhaustion_count</strong> — number of markets with <span class="eq">exhaustion_risk = True</span>.</li>
      </ul>
      <p class="leading-7 mt-3">These raw counts are then converted into shares to make the signal comparable over time:</p>
      <div class="box text-sm">
        <div class="eq">squeeze\_share = squeeze\_count / n\_markets</div>
        <div class="eq">exhaustion\_share = exhaustion\_count / n\_markets</div>
      </div>
      <p class="leading-7 mt-3">If <span class="eq">n_markets = 0</span> on any date, it is replaced with NaN to avoid division by zero.</p>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">3. Normalised Signal Construction</h2>
      <p class="leading-7">To stabilise the breadth measures and place them on a comparable scale, a robust z-score transformation is applied separately to squeeze_share and exhaustion_share:</p>
      <div class="box text-sm mt-3">
        <div class="eq">z\_{rob}(X) = \dfrac{X - median(X)}{1.4826 \cdot MAD(X)}</div>
      </div>
      <p class="leading-7 mt-3">Here, <span class="eq">MAD(X)</span> is the median absolute deviation. Using median/MAD instead of mean/standard deviation makes the signal more resilient to outliers and structural breaks in the CoT sample.</p>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">4. Regime Labelling</h2>
      <p class="leading-7">The normalised values are mapped into intuitive risk regimes using symmetric thresholds:</p>
      <div class="box text-sm mt-3">
        <div class="eq">z \ge 1.0 \Rightarrow \textit{High Squeeze Risk}</div>
        <div class="eq">0.5 \le z < 1.0 \Rightarrow \textit{Moderate Squeeze Risk}</div>
        <div class="eq">z < 0.5 \Rightarrow \textit{Normal}</div>
      </div>
      <p class="leading-7 mt-3">The same thresholds are applied to the exhaustion z-score to define <em>High Exhaustion Risk</em>, <em>Moderate Exhaustion Risk</em>, and <em>Normal</em> exhaustion conditions.</p>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">5. Implementation (Python)</h2>
      <div class="box text-sm">
<pre><code>df_se = df_cot_signals.copy()
df_se["Report_Date"] = pd.to_datetime(df_se["Report_Date"], errors="coerce")

# Ensure flags exist
for flag in ["squeeze_risk", "exhaustion_risk", "crowded_long", "crowded_short"]:
    if flag not in df_se.columns:
        df_se[flag] = False

# Aggregation
df_squeeze_exhaust = (
    df_se.groupby("Report_Date").agg(
        n_markets=("Market_and_Exchange_Names", "nunique"),
        squeeze_count=("squeeze_risk", "sum"),
        exhaustion_count=("exhaustion_risk", "sum"),
        crowded_long_count=("crowded_long", "sum"),
        crowded_short_count=("crowded_short", "sum"),
    ).reset_index()
)

df_squeeze_exhaust["n_markets"] = df_squeeze_exhaust["n_markets"].replace(0, np.nan)

df_squeeze_exhaust["squeeze_share"] = (
    df_squeeze_exhaust["squeeze_count"] / df_squeeze_exhaust["n_markets"]
)

df_squeeze_exhaust["exhaustion_share"] = (
    df_squeeze_exhaust["exhaustion_count"] / df_squeeze_exhaust["n_markets"]
)

# Robust z-score helper
def _robust_z(series: pd.Series) -> pd.Series:
    x = pd.to_numeric(series, errors="coerce").astype(float)
    med = x.median()
    mad = (x - med).abs().median()
    if mad == 0 or np.isnan(mad):
        return pd.Series(np.nan, index=series.index)
    return (x - med) / (1.4826 * mad)

# Normalised signals
df_squeeze_exhaust["Squeeze_z"] = _robust_z(df_squeeze_exhaust["squeeze_share"])
    
df_squeeze_exhaust["Exhaustion_z"] = _robust_z(df_squeeze_exhaust["exhaustion_share"])

# Regime labels
def _squeeze_label(z: float) -> str:
    if pd.isna(z):
        return "Unknown"
    if z &gt;= 1.0:
        return "High Squeeze Risk"
    if 0.5 &lt;= z &lt; 1.0:
        return "Moderate Squeeze Risk"
    return "Normal"


def _exhaust_label(z: float) -> str:
    if pd.isna(z):
        return "Unknown"
    if z &gt;= 1.0:
        return "High Exhaustion Risk"
    if 0.5 &lt;= z &lt; 1.0:
        return "Moderate Exhaustion Risk"
    return "Normal"


df_squeeze_exhaust["Squeeze_Regime"] = df_squeeze_exhaust["Squeeze_z"].apply(_squeeze_label)

df_squeeze_exhaust["Exhaustion_Regime"] = df_squeeze_exhaust["Exhaustion_z"].apply(_exhaust_label)
</code></pre>
      </div>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">6. Interpretation</h2>
      <ul class="list-disc pl-6 leading-7">
        <li><strong>High Squeeze Risk</strong> — squeeze flags are elevated across a wide set of markets, indicating vulnerability to sharp, flow-driven moves.</li>
        <li><strong>High Exhaustion Risk</strong> — exhaustion flags are widespread, suggesting that prevailing trends may be losing momentum.</li>
        <li><strong>Normal</strong> — breadth of squeeze or exhaustion conditions is close to its historical median, signalling typical tactical risk.</li>
      </ul>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">7. Limitations</h2>
      <ul class="list-disc pl-6 leading-7">
        <li>Breadth measures ignore sector composition; concentrated stress in a key sector may be downplayed.</li>
        <li>Flag quality depends on upstream definitions of squeeze_risk and exhaustion_risk.</li>
        <li>Static z-thresholds may need recalibration as the number and mix of markets in df_cot_signals evolve.</li>
      </ul>
    </section>

    <section class="mb-10">
      <h2 class="text-2xl font-semibold mb-3">8. Practical Use Cases</h2>
      <ul class="list-disc pl-6 leading-7">
        <li>Gauge whether the futures complex is in a fragile state prone to squeezes.</li>
        <li>Flag periods where widespread exhaustion risk suggests caution on trend-following strategies.</li>
        <li>Use as a tactical overlay in macro risk management alongside volatility, liquidity, and positioning composites.</li>
      </ul>
    </section>

    <footer class="text-sm text-slate-500 border-t pt-6">© 2025. Methodology reference for the Squeeze &amp; Exhaustion Breadth signal.</footer>
  </main>
</body>
</html>
